# Instructions to build this backend

by Franco Rivera Rivas  

based on: https://scotch.io/tutorials/build-a-restful-json-api-with-rails-5-part-one


# Requirements:

Ruby (2.7)
Rails (5.0)

```
gem install rails 
```

Start a new projecft in directory (--api option as we only want the api, no frontend, and -T to exclude minitests)


```
rails new juergapp-api --api -T
```

## Time to add some dependendicies

First open your Gemfile
```
cd juergapp-api
vim Gemfile
```

Now locate the development and test group and add the following

```
group :development, :test do
  gem 'rspec-rails', '~> 3.5'
end
```

Now outside of that group create/add these gems

```
group :test do
  gem 'factory_bot_rails', '~> 4.0'
  gem 'shoulda-matchers', '~> 3.1'
  gem 'faker'
  gem 'database_cleaner'
end
```

Finally install the gems by closing the file and running

```
bundle install
```

## Setting up for tests

Create the folder (spec) where our tests will be placed by running the command

```
rails generate rspec:install
```

Now create the directory where our fake data for the tests will be generated by FactoryBot

```
mkdir spec/factories
```

Time to configure the rails helper in 'spec/rails_helper.rb'

Add the following bellow the line that reads "add aditional requires below this lines"

```
require 'database_cleaner'
```

Then below that before 'Rspec.configure' do add:

```
# configure shoulda matchers to use rspec as the test framework and full matcher libraries for rails
Shoulda::Matchers.configure do |config|
  config.integrate do |with|
    with.test_framework :rspec
    with.library :rails
  end
end
```

And within 'Rspec.configure do':

```
# add `FactoryBot` methods
  config.include FactoryBot::Syntax::Methods

  # start by truncating all the tables but then use the faster transaction strategy the rest of the time.
  config.before(:suite) do
    DatabaseCleaner.clean_with(:truncation)
    DatabaseCleaner.strategy = :transaction
  end

  # start the transaction strategy as examples are run
  config.around(:each) do |example|
    DatabaseCleaner.cleaning do
      example.run
    end
  end
```

That was long but now we are ready to add models

## Models

The Syntax to add models is the following:

```
rails g model MODEL_NAME COLUMN_NAME:TYPE COLUMN_NAME:TYPE
```


If we see Juergapp has 5 main models which are the following:

```
# This was created first based on Sprint #2

rails g model User name:string password_digest:string DNI:string email:string phone:string  
rails g model Event name:string description:text address:string latitude:decimal \
		    longitude:decimal date:datetime user:references

# These are not created as of Sprint #2

rails g model Game title:string created_by:string
rails g model Product name:string description:text picture:string 
rails g model Proveedor name:string direccion:string
```

## SOME Ruby on Rails theory

N.B. Rails create by default created_at and updated_at


### This are the data types the models can be

```
	primary_key
	string
	text
	integer
	float
	decimal
	datetime
	timestamp
	time
	date
	binary
	boolean
	references 
```

N.B. use TABLE_NAME:references when you want to add a foreign key to another table

## Add, modify or remove columns of created models

Taken from: https://guides.rubyonrails.org/active_record_migrations.html

If the migration name is of the form "AddXXXToYYY" or "RemoveXXXFromYYY" and is followed by a list of column names and types then a migration containing the appropriate add_column and remove_column statements will be created.

For example:

```
rails generate migration AddPartNumberToProducts part_number:string
```

### And to modify a column "ChangeXXXtoYYY"

Find the migration file and add for example
```
rename_column :users, :email, :email_address
```

### Join two tables

rails g migration CreateCategoriesUsersJoinTable`

create_join_table :categories, :users

## PRACTICE

Before doing the migrations we have to do some changes, we want to change the column name from the table Event "user" to "organizer"

So open the migration for Event found at migrations/Create_Event.rb


### Create the migrations

```
#makes migrations
rails db:migrate
# makes sure test environment is ready
```

## Adding the User model spec (for tests) /specs/models/user_spec.rb

Within the file we have to create the validations:

```
  # Line below is for a one to many relationship
  # it { should have_many(:todos) }

  it { should validate_presence_of(:name) }
  it { should validate_presence_of(:email) }
  it { should validate_presence_of(:phone) }
  it { should validate_presence_of(:DNI) }
  it { should validate_presence_of(:email) }
  it { should validate_presence_of(:password_digest) }
```


## Adding factory, to auto deploy test data

Modify file in spec/factories/users.rb

```
FactoryBot.define do
  factory :user do
    name { Faker::Name.name }
    email 'foo@bar.com'
    password 'foobar'
  end
end
```

### Implement the user model (so factory bot creates the users and all) its not magic

```
class User < ApplicationRecord
  # encrypt password
  has_secure_password

  # Model associations
  has_many :todos, foreign_key: :created_by
  # Validations
  validates_presence_of :name, :email, :password_digest
end
```
# Add bcrypt to the gemfile

## (just delete the comment on line 17)

```
gem 'bcrypt', '~>3.1.7'
gem 'jwt'
```

Now you can bundle install and run the tests with rspec


Now, see the jwt gem we just install? thats to use JsonWebTokens

```
mkdir app/lib
touch app/lib/json_web_token.rb
```

Within add the following

### TODO, add the code app/controllers/conecerns/exception_hander.rb

```
# create auth folder to house auth services
mkdir app/auth
touch app/auth/authorize_api_request.rb

# Create corresponding spec files
mkdir spec/auth
touch spec/auth/authorize_api_request_spec.rb
```

### TODO, add spec/auth/authorize_api_request_spec.rb here

Now lets add json token helper classes for the tests

```
mkdir spec/support
touch spec/support/controller_spec_helper.rb
```

### TODO, add spec/support/controller_spec_helper.rb

Now we have to add these helpers to rails helper so we can use them

So open spec/rails_helper  and under RSpec.configure do |config| 

``` 
  config.include RequestSpecHelper
  config.include ControllerSpecHelper
```
Also uncomment line 26 (DIR[Rails.root.join...) if you havent already

FRANCO:Not sure about this
Add database_cleaner to the top (should be by default)

```
require 'database_cleaner'
```

## TODO add app/auth/authorize_api_request.rb and also add app/lib/message.rb, and add serets
## Also add spec/support/request_spec_helper.rb

Add the authentication controller

```
rails g controller Authentication
rails g controller Me
```

Time to add specs for the authentication /spec/requests/authentication_spec.rb

```
mkdir spec/requests
```

And the controller to handle the authentication app/controllers/authentication_controller.rb

And add the route for the login in config/routes.rb

```
post 'auth/login', to: 'authentication#authenticate'
post 'signup', to: 'users#create'
```

Now we can login our users, but first we have to let them sign up !

Lets start creating the controller

```
rails g controller Users
```

and add the user spec!! for tests ye :)

```
touch spec/requests/users_spec.rb
```

Now time to make all the routes for auth copy spec/controllers/application_controller_spec.rb
and also add app/controllers/application_controller.rb


# To add two references to same class
## Taken from
https://www.sitepoint.com/community/t/referencing-the-same-model-twice-in-rails/254243/2

1. Create the migration with two :references field
2. Remove foreign_key true from migration, so that rails
3. Edit model files to include 

class Survey < ApplicationRecord
  belongs_to :owner, :class_name => 'User'
  belongs_to :admin, :class_name => 'User'
end
class User < ApplicationRecord
  has_many :owned_surveys, :class_name => 'Survey', :foreign_key => 'owner_id'
  has_many :admin_surveys, :class_name => 'Survey', :foreign_key => 'admin_id'
end

To add a friendship


TODO ADD HERE THE FRIENdSHIP

Assuming database is 

rails g model Friendship user:references friendship:references 

Delete the foreign key from both of these (we dont really wanna validate)

friendship.rb
belongs_to :friend_one, :foreign_key => :user_id

belongs_to :friend_two, :foreign_key => :friend_id
and

user.rb

has_many :friendship_ones, :class_name => 'Friendship', :foreign_key => :friend_id
has_many :friend_ones, through: :friendship_ones
has_many :friendship_twos, :class_name => 'Friendship', :foreign_key => :user_id
has_many :friend_twos, through: :friendship_twos


def friends
  friend_ones + friend_twos
end

to ensure uniqueness:

rails g migration AddIndexToFriendship

class AddUniqueIndexToReleases < ActiveRecord::Migration
  def change
    add_index :invitations, [:event_id, :guest_id, :host_id], unique: true
    remove_index :invitations, column: [:guest_id, :host_id, :event_id]

    remove_index :invitations, name:  "name_of_index" 
  end


end



class Release < ActiveRecord::Base
  validates :country, uniqueness: { scope: :medium }
end


